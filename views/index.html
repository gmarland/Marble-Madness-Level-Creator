<html>
	<head>
		<title>Marble Madness Level Editor</title>
		<script type="text/javascript" src="/third-party-libs/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="/third-party-libs/three.min.js"></script>
		<script type="text/javascript" src="/third-party-libs/jscolor.js"></script>
		<script type="text/javascript" src="/libs/FirstPersonControls.js"></script>
		<script type="text/javascript" src="/libs/MarbleViewEngine.js"></script>
		<script type="text/javascript" src="/libs/levelEditor.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	  	<link type="text/css" href="/css/main.css" rel="stylesheet" />
	</head>
	<body>
		<div id="scene-container" oncontextmenu="return false">
		<div id="settings-container">
			<img id="settings" src="/images/settings.svg" border="0" class="selectable" onclick="toggleSettingsSelect();" />
			<div id="settings-menu" class="menu" style="display: none;">
				<div id="edit-details-button" onclick="editScene();" style="display: none;">Edit</div>
				<div id="save-btn" onclick="saveScene();">Save</div>
			</div>
		</div>
		<div id="shape-select-container">
			<div id="selected-shape-container" class="left" style="margin-left:3px;margin-top:3px;">
				<img id="selected-shape" src="images/square.png" border="0" class="selectable" onclick="toggleShapeSelect()" />
			</div>
			<div class="right">
				<div class="table">
					<div class="row">
						<div class="cell" style="padding-bottom:2px;"><img src="images/up-arrow.png" border="0" class="selectable" onclick="rotateUp()" /></div>
					</div>
					<div class="row">
						<div class="cell" style="padding-top:2px;"><img src="images/down-arrow.png" border="0" class="selectable" onclick="rotateDown()" /></div>
					</div>
				</div>
			</div>
			<div class="clear"></div>
			<div class="table" style="margin-left:1px;">
				<div class="row">
					<div class="cell left-aligned" style="padding-right:2px;"><img src="images/left-arrow.png" border="0" class="selectable" onclick="rotateLeft()" /></div>
					<div class="cell right-aligned" style="padding-left:2px;"><img src="images/right-arrow.png" border="0" class="selectable" onclick="rotateRight()" /></div>
				</div>
			</div>
			<div id="all-shapes" class="table menu" style="display: none;">
				<div class="row">
					<div class="cell centered"><img src="images/square.png" border="0" class="selectable" onclick="setShape('square')" /></div>
					<div class="cell centered"><img src="images/triangle.png" border="0" class="selectable" onclick="setShape('triangle')" /></div>
					<div class="cell centered"><img src="images/pyramid.png" border="0" class="selectable" onclick="setShape('pyramid')" /></div>
				</div>
			</div>
		</div>
		<div id="color-select-container"><input type="button" id="color-select" class="jscolor" onchange="setColor(this.jscolor)" /></div>
		<div id="modal-dialog-overlay" style="display: none;"></div>
		<script type="text/javascript">	
			// ---- Data access methods

			function getURLParam(name) {
				var urlParts = window.location.href.split("/");

				if (urlParts.length > 0) {
					var lastElements = urlParts[urlParts.length - 1].split("?");

					if (lastElements.length > 0) {
						var lastElement = lastElements[0];

						if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(lastElement)) return lastElement;
						else return null;
					}
				}	
			}

			function getQueryParam(name) {
			    var url = window.location.href;

			    name = name.replace(/[\[\]]/g, "\\$&");

			    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			        results = regex.exec(url);
			    
			    if (!results) return null;
			    
			    if (!results[2]) return null;
			    
			    return decodeURIComponent(results[2].replace(/\+/g, " "));
			}

			// ----- Methods for the setting menu

			function toggleSettingsSelect() {
				if ($("#settings-menu").is(":visible")) hideSettingsSelect();
				else openSettingsSelect();
			}

			function openSettingsSelect() {
				$("#settings-menu").show();	
			}

			function hideSettingsSelect() {
				$("#settings-menu").hide();
			}

			function closeModalDialog() {
				$("#modal-dialog-overlay").empty();
				$("#modal-dialog-overlay").hide();

				levelEditor.setControlsEnabled(true);
			}

			// ----- Saving scene method

			function saveScene() {
				hideSettingsSelect();

				if (levelEditor.getId() != null) levelEditor.save();
				else {
					levelEditor.setControlsEnabled(false);

	                $.ajax({
	                    url: "/dialogs/save",
	                    type: "GET",
	                    success: function (response) {
							$("#modal-dialog-overlay").html(response);
							$("#modal-dialog-overlay").show();
	                    }
	                });
				}
			}

			// ----- Saving details method

			function editScene() {
				hideSettingsSelect();

				levelEditor.setControlsEnabled(false);

                $.ajax({
                    url: "/dialogs/edit",
                    type: "GET",
                    success: function (response) {
						$("#modal-dialog-overlay").html(response);

						$("#edit-scene-name").val(levelEditor.getName());

						$("#modal-dialog-overlay").show();
                    }
                });
			}

			function updateScene(name) {
				levelEditor.setName(name);
				levelEditor.save();

				closeModalDialog();

				$("#edit-details-button").show();
				$("#settings-menu").addClass("editable");
			}

			// ----- Methods to set colors

			function setColor(color) {	
				levelEditor.setColor(color.toString());
			}

			// ----- Methods for managing shapes

			function toggleShapeSelect() {
				if ($("#all-shapes").is(":visible")) hideShapeSelect();
				else openShapeSelect();
			}

			function openShapeSelect() {
				$("#all-shapes").show();	
			}

			function hideShapeSelect() {
				$("#all-shapes").hide();
			}

			function setShape(shape) {
				levelEditor.setShape(shape);

				$("#selected-shape").attr("src", "images/" + shape + ".png");

				hideShapeSelect();
			}

			// ----- Methods for rotating a shape

			function rotateLeft() {
				levelEditor.setXRotation(-90);
			}

			function rotateRight() {
				levelEditor.setXRotation(90);
			}

			function rotateUp() {
				levelEditor.setYRotation(-90);				
			}

			function rotateDown() {
				levelEditor.setYRotation(90);
			}

			// ----- Event binding

			document.addEventListener('keyup', function(e) {
				var keyCode = e.code.toLowerCase();
				var level = levelEditor.getLevel();

				if (keyCode == "arrowup") levelEditor.setLevel((level+1));
				else if (keyCode == "arrowdown") levelEditor.setLevel((level-1));
			}, false);


			// Initialize the editor

			var startColor = "#ff0000";

			$("#color-select").val(startColor);

			var levelEditor = (new LevelEditor());

			levelEditor.start("scene-container", startColor);
			
			levelEditor.onError = function(message) {
                $.ajax({
                    url: "/dialogs/error",
                    type: "GET",
                    success: function (response) {
						$("#modal-dialog-overlay").html(response);

						$("#error-message").html(message);

						$("#modal-dialog-overlay").show();
                    }
                });
			};

			levelEditor.onLoad = function() {
				$("#edit-details-button").show();
				$("#settings-menu").addClass("editable");
			};

			var sceneId = getURLParam("id");
			if (sceneId != null) levelEditor.load(sceneId);
		</script>
	</body>
</html>